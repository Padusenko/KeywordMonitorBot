# handlers/common.py

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import CommandStart, Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import any_state

from keyboards.reply import main_menu
from database import add_user

router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    await add_user(message.from_user.id)
    
    welcome_text = (
        f"<b>–ü—Ä–∏–≤—ñ—Ç, {message.from_user.full_name}!</b>\n\n"
        "–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –±–æ—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ —É Telegram-–∫–∞–Ω–∞–ª–∞—Ö.\n\n"
        "–©–æ–± –ø–æ—á–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂—á–µ."
    )

    await message.answer(welcome_text, parse_mode="HTML", reply_markup=main_menu)


@router.message(F.text == "‚ÑπÔ∏è –ü—Ä–æ –±–æ—Ç–∞")
async def cmd_about(message: Message):
    about_text = (
        "‚ÑπÔ∏è <b>–ü—Ä–æ –±–æ—Ç–∞ —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</b>\n\n"
        "–¶–µ–π –±–æ—Ç –¥–æ–∑–≤–æ–ª—è—î –≥–Ω—É—á–∫–æ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ —É –±—É–¥—å-—è–∫–∏—Ö –ø—É–±–ª—ñ—á–Ω–∏—Ö Telegram-–∫–∞–Ω–∞–ª–∞—Ö.\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω—ñ –ø–æ–Ω—è—Ç—Ç—è:</b>\n"
        "üìÑ <b>–õ–æ–∫–∞–ª—å–Ω–µ —Å–ª–æ–≤–æ</b> ‚Äî –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –≤ —Ç–∏—Ö –∫–∞–Ω–∞–ª–∞—Ö, –¥–æ —è–∫–∏—Ö –≤–∏ –π–æ–≥–æ –≤–ª–∞—Å–Ω–æ—Ä—É—á –ø—Ä–∏–≤'—è–∑–∞–ª–∏.\n"
        "üåê <b>–ì–ª–æ–±–∞–ª—å–Ω–µ —Å–ª–æ–≤–æ</b> ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —à—É–∫–∞—î—Ç—å—Å—è —É <u>–≤—Å—ñ—Ö</u> –∫–∞–Ω–∞–ª–∞—Ö, —è–∫—ñ –≤–∏ –¥–æ–¥–∞–ª–∏.\n\n"
        "--- --- ---\n\n"
        "<b>–ö—Ä–æ–∫ 1: –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–∞–Ω–∞–ª–∞–º–∏ (–º–µ–Ω—é 'üóÇÔ∏è –ú–æ—ó –∫–∞–Ω–∞–ª–∏')</b>\n\n"
        "1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å <b>'‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∫–∞–Ω–∞–ª'</b> —Ç–∞ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–∞–Ω–∞–ª (–Ω–∞–ø—Ä., `@durov` –∞–±–æ `https://t.me/durov`).\n"
        "2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ <b>–∫–Ω–æ–ø–∫—É –∑ –Ω–∞–∑–≤–æ—é –∫–∞–Ω–∞–ª—É</b>, —â–æ–± –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –π–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.\n"
        "3. –£ –º–µ–Ω—é –∫–∞–Ω–∞–ª—É –≤–∏ –º–æ–∂–µ—Ç–µ:\n"
        "   - <b>'üîó –ü—Ä–∏–≤'—è–∑–∞—Ç–∏ —Å–ª–æ–≤–æ –∑—ñ —Å–ø–∏—Å–∫—É'</b>: –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å—ñ –≤–∞—à—ñ —Å–ª–æ–≤–∞ —Ç–∞ –≤—ñ–¥–º—ñ—Ç–∏—Ç–∏ (‚úÖ), —è–∫—ñ –∑ –Ω–∏—Ö –º–∞—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ —Ü—å–æ–º—É –∫–∞–Ω–∞–ª—ñ.\n"
        "   - <b>'‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –ª–æ–∫–∞–ª—å–Ω–µ —Å–ª–æ–≤–æ'</b>: –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ —Å–ª–æ–≤–æ, —è–∫–µ –æ–¥—Ä–∞–∑—É –±—É–¥–µ –ø—Ä–∏–≤'—è–∑–∞–Ω–µ —Ç—ñ–ª—å–∫–∏ –¥–æ —Ü—å–æ–≥–æ –∫–∞–Ω–∞–ª—É.\n"
        "   - <b>'üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–∞–Ω–∞–ª'</b>: –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–∞–Ω–∞–ª –∑ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É.\n"
        "   - –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –Ω–∞ <b>'üìÑ –°–ª–æ–≤–æ ‚ùå'</b>, —â–æ–± —à–≤–∏–¥–∫–æ –≤—ñ–¥–≤'—è–∑–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–µ —Å–ª–æ–≤–æ –≤—ñ–¥ –∫–∞–Ω–∞–ª—É.\n\n"
        "--- --- ---\n\n"
        "<b>–ö—Ä–æ–∫ 2: –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ (–º–µ–Ω—é 'üìù –ú–æ—ó –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞')</b>\n\n"
        "1. –¶–µ –≤–∞—à <b>–∑–∞–≥–∞–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫</b>. –¢—É—Ç –≤–∏ –±–∞—á–∏—Ç–µ –≤—Å—ñ —Å–ª–æ–≤–∞, —è–∫—ñ –≤–∏ –∫–æ–ª–∏-–Ω–µ–±—É–¥—å –¥–æ–¥–∞–≤–∞–ª–∏.\n"
        "2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å <b>'‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ —Å–ª–æ–≤–æ'</b>, —â–æ–± –ø–æ–ø–æ–≤–Ω–∏—Ç–∏ —Å–≤—ñ–π —Å–ª–æ–≤–Ω–∏–∫. –ù–æ–≤—ñ —Å–ª–æ–≤–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —î –ª–æ–∫–∞–ª—å–Ω–∏–º–∏ (üìÑ).\n"
        "3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ <b>–∫–Ω–æ–ø–∫—É-—Å–ª–æ–≤–æ –∑ —Ö—Ä–µ—Å—Ç–∏–∫–æ–º (‚ùå)</b>, —â–æ–± –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç–∏ –π–æ–≥–æ –∑ —Å–∏—Å—Ç–µ–º–∏ (–≤–∫–ª—é—á–∞—é—á–∏ –≤—Å—ñ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ –∫–∞–Ω–∞–ª—ñ–≤).\n\n"
        "--- --- ---\n\n"
        "üí° <b>–ü–æ—Ä–∞–¥–∞:</b> –©–æ–± –∑—Ä–æ–±–∏—Ç–∏ —Å–ª–æ–≤–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–º, —Å–ø–µ—Ä—à—É –¥–æ–¥–∞–π—Ç–µ –π–æ–≥–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é 'üóÇÔ∏è –ú–æ—ó –∫–∞–Ω–∞–ª–∏' -> 'üåê –î–æ–¥–∞—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–µ —Å–ª–æ–≤–æ'.\n\n"
        "–î–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ—ó –¥—ñ—ó –≤ –ø—Ä–æ—Ü–µ—Å—ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è (–∫–æ–ª–∏ –±–æ—Ç —â–æ—Å—å –æ—á—ñ–∫—É—î) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫—É <b>'‚¨ÖÔ∏è –°–∫–∞—Å—É–≤–∞—Ç–∏'</b> –∞–±–æ –∫–æ–º–∞–Ω–¥—É /cancel."
    )
    await message.answer(about_text, parse_mode="HTML")


# –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤–∏—Ö–æ–¥—É –∑—ñ —Å—Ç–∞–Ω—ñ–≤
@router.message(StateFilter(any_state), F.text == "‚¨ÖÔ∏è –°–∫–∞—Å—É–≤–∞—Ç–∏")
@router.message(StateFilter(any_state), Command("cancel"))
async def cancel_handler(message: Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state is None:
        return

    await state.clear()
    await message.answer(
        "–î—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ. –í–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é.",
        reply_markup=main_menu # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≥–æ–ª–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
    )

@router.callback_query(F.data == "back_to_main_menu")
async def back_to_main_menu_handler(callback: CallbackQuery):
    """
    –û–±—Ä–æ–±–ª—è—î –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é",
    —Ä–µ–¥–∞–≥—É—é—á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –ø–æ–≤–µ—Ä—Ç–∞—é—á–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Ç–µ–∫—Å—Ç.
    """
    # –¢–µ–∫—Å—Ç, —è–∫–∏–π –±—É–≤ —É –Ω–∞–π–ø–µ—Ä—à–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –ø—ñ—Å–ª—è /start
    main_menu_text = (
        f"<b>–ü—Ä–∏–≤—ñ—Ç, {callback.from_user.full_name}!</b>\n\n"
        "–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –±–æ—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ —É Telegram-–∫–∞–Ω–∞–ª–∞—Ö.\n\n"
        "–©–æ–± –ø–æ—á–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂—á–µ."
    )
    
    # –†–µ–¥–∞–≥—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ inline-–∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
    await callback.message.edit_text(main_menu_text, parse_mode="HTML", reply_markup=None)
    
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –Ω–∞ –∫–æ–ª–±–µ–∫, —â–æ–± –∑–Ω–∏–∫ "–≥–æ–¥–∏–Ω–Ω–∏–∫" –Ω–∞ –∫–Ω–æ–ø—Ü—ñ
    await callback.answer()